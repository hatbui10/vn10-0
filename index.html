<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Kiểm tra 4 bit liên tiếp</title>
<style>
body{
    background:#1e1e2f;
    color:white;
    font-family:Arial;
    padding:20px;
}

.line{
    padding:6px;
    font-size:18px;
}

.highlight{
    background:black;
    color:#00ff99;
}
</style>
</head>
<body>

<h2>Kiểm tra 4 bit liên tiếp khác nhau</h2>

<input type="file" id="fileInput" accept=".txt">
<button onclick="processFile()">Xử lý</button>

<div id="output"></div>

<script>

const ruleMap = {
    "1": [2,3,5],
    "2": [2,5],
    "3": [1,4],
    "4": [1,2],
    "5": [2,5],

    "1-2": [2,3],
    "1-3": [1,3],
    "1-4": [2,3],
    "1-5": [3],
    "2-3": [2,3,5],
    "2-4": [3,5],
    "2-5": [2,4],
    "3-4": [2,4],
    "3-5": [1,5],
    "4-5": [2,5],

    "1-2-3": [3,5],
    "1-2-4": [3,5],
    "1-2-5": [2,4],
    "1-3-5": [2,4],
    "1-3-4": [2,5],
    "1-4-5": [2,4],
    "2-4-5": [2,4,5],
    "2-3-4": [1,5],
    "2-3-5": [1,4],
    "3-4-5": [1,2],

    "1-2-3-4": [3],
    "1-2-3-5": [2,5],
    "1-2-4-5": [2,4,5],
    "1-3-4-5": [3],
    "2-3-4-5": [2,4,5],

    "1-2-3-4-5": [3,5],
    "": [2,5]

};

function flip(bit){
    return bit === "0" ? "1" : "0";
}

function applyRule(base, test){

    let baseBits = base.split("");
    let testBits = test.split("");

    let diffPositions = [];

    for(let i=0;i<5;i++){
        if(baseBits[i] !== testBits[i]){
            diffPositions.push(i+1);
        }
    }

    let key = diffPositions.sort((a,b)=>a-b).join("-");

    if(ruleMap[key]){
        ruleMap[key].forEach(pos=>{
            testBits[pos-1] = flip(testBits[pos-1]);
        });
    }

    return testBits.join("");
}

function has4ConsecutiveDiff(a, b){

    for(let start = 0; start <= 1; start++){

        let ok = true;

        for(let i = start; i < start + 4; i++){
            if(a[i] === b[i]){
                ok = false;
                break;
            }
        }

        if(ok) return true;
    }

    return false;
}

function processFile(){

    const file = document.getElementById("fileInput").files[0];
    if(!file) return;

    const reader = new FileReader();

    reader.onload = function(e){

        let rawLines = e.target.result.split("\n");

        let displayLines = rawLines
            .map(l => l.trim())
            .filter(l => l.length > 0);

        let lines = displayLines.map(l => l.replace(/-/g,""));

        let outputDiv = document.getElementById("output");
        outputDiv.innerHTML = "";

        let highlightIndexes = new Set();
        let resultAForLine = {};

        for(let i=0; i < lines.length-2; i++){

            let A = applyRule(lines[i], lines[i+1]);

            if(has4ConsecutiveDiff(A, lines[i+2])){
                highlightIndexes.add(i);
                highlightIndexes.add(i+1);
                highlightIndexes.add(i+2);

                // CHỈ lưu A nếu thỏa điều kiện
                resultAForLine[i+2] = A;
            }
        }

        displayLines.forEach((line, index)=>{

            let div = document.createElement("div");
            div.className = "line";

            if(highlightIndexes.has(index)){
                div.classList.add("highlight");
            }

            let text = line;

            if(resultAForLine[index]){
                let formattedA = resultAForLine[index].split("").join("-");
                text += "   |   A = " + formattedA;
            }

            div.textContent = text;
            outputDiv.appendChild(div);
        });
    };

    reader.readAsText(file);
}

</script>

</body>
</html>
