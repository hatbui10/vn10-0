<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Bit Rule Engine IPFS</title>
<style>
body{
    background:#1e1e2f;
    color:white;
    font-family:Arial;
    padding:20px;
}

.line{
    padding:6px;
    font-size:18px;
}

.highlight{
    background:black;
    color:#00ff99;
}
</style>
</head>
<body>

<h2>Bit Rule Engine (IPFS Auto Load)</h2>

<button onclick="loadFromIPFS()">Tải lại</button>

<div id="output">Đang tải dữ liệu...</div>

<script>

const ipfsURL = "https://tomato-delicate-zebra-533.mypinata.cloud/ipfs/bafybeianxazt5mo6hclvc7kvxbkizn634a762gnt3giewin5fmdhaim2zm";

const ruleMap = {
    "1": [2,3,5],
    "2": [2,5],
    "3": [1,4],
    "4": [1,2],
    "5": [2,5],

    "1-2": [2,3],
    "1-3": [1,3],
    "1-4": [2,3],
    "1-5": [3],
    "2-3": [2,3,5],
    "2-4": [3,5],
    "2-5": [2,4],
    "3-4": [2,4],
    "3-5": [1,5],
    "4-5": [2,5],

    "1-2-3": [3,5],
    "1-2-4": [3],
    "1-2-5": [2,4],
    "1-3-5": [2,4],
    "1-3-4": [2,5],
    "1-4-5": [2,4],
    "2-4-5": [2,4,5],
    "2-3-4": [1,5],
    "2-3-5": [1,4],
    "3-4-5": [1,5],

    "1-2-3-4": [3],
    "1-2-3-5": [2,5],
    "1-2-4-5": [2,4,5],
    "1-3-4-5": [3],
    "2-3-4-5": [2,4,5],

    "1-2-3-4-5": [3,5],
    "": [2,5]
};

function flip(bit){
    return bit === "0" ? "1" : "0";
}

function applyRule(base, test){

    let baseBits = base.split("");
    let testBits = test.split("");

    let matchPositions = [];

    for(let i=0;i<5;i++){
        if(baseBits[i] === testBits[i]){
            matchPositions.push(i+1);
        }
    }

    let matchKey = matchPositions.join("-");

    if(ruleMap.hasOwnProperty(matchKey)){
        ruleMap[matchKey].forEach(pos=>{
            testBits[pos-1] = flip(testBits[pos-1]);
        });
    }

    return testBits.join("");
}

function has4ConsecutiveDiff(a, b){

    for(let start = 0; start <= 1; start++){

        let ok = true;

        for(let i = start; i < start + 4; i++){
            if(a[i] === b[i]){
                ok = false;
                break;
            }
        }

        if(ok) return true;
    }

    return false;
}

function processText(text){

    let rawLines = text.split("\n");

    let displayLines = rawLines
        .map(l => l.trim())
        .filter(l => l.length > 0);

    let lines = displayLines.map(l => l.replace(/-/g,""));

    let outputDiv = document.getElementById("output");
    outputDiv.innerHTML = "";

    let highlightIndexes = new Set();
    let resultAForLine = {};

    for(let i=0; i < lines.length-2; i++){

        let A = applyRule(lines[i], lines[i+1]);

        if(has4ConsecutiveDiff(A, lines[i+2])){
            highlightIndexes.add(i);
            highlightIndexes.add(i+1);
            highlightIndexes.add(i+2);

            resultAForLine[i+2] = A;
        }
    }

    displayLines.forEach((line, index)=>{

        let div = document.createElement("div");
        div.className = "line";

        if(highlightIndexes.has(index)){
            div.classList.add("highlight");
        }

        let textLine = line;

        if(resultAForLine[index]){
            let formattedA = resultAForLine[index].split("").join("-");
            textLine += "   |   A = " + formattedA;
        }

        div.textContent = textLine;
        outputDiv.appendChild(div);
    });
}

function loadFromIPFS(){

    document.getElementById("output").innerHTML = "Đang tải dữ liệu...";

    fetch(ipfsURL)
        .then(res => res.text())
        .then(data => processText(data))
        .catch(err => {
            document.getElementById("output").innerHTML =
                "<div style='color:red'>Không tải được dữ liệu từ IPFS</div>";
        });
}

window.onload = loadFromIPFS;

</script>

</body>
</html>
